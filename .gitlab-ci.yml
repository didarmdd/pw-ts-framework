image: mcr.microsoft.com/playwright:v1.49.0-jammy

stages:
  - test
  - deploy
  - notify

variables:
  ENV: dev
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

before_script:
  - npm ci
  - npx playwright install --with-deps
  - mkdir -p env
  - |
    cat > env/${ENV}.env << EOF
    BASE_URL=${BASE_URL}
    API_URL=${API_URL}
    AUTH_MODE=${AUTH_MODE}
    USERNAME=${USERNAME}
    PASSWORD=${PASSWORD}
    API_TOKEN=${API_TOKEN}
    EOF

smoke_tests:
  stage: test
  script:
    - npm run test:smoke
    - npm run allure:generate || true
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - artifacts/playwright-report
      - artifacts/test-results
      - artifacts/allure-report

regression_tests:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - when: manual
  script:
    - npm run test
    - npm run allure:generate || true
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - artifacts/playwright-report
      - artifacts/test-results
      - artifacts/allure-report

pages:
  stage: deploy
  script:
    - mkdir -p public
    - |
      if [ -d "artifacts/playwright-report" ]; then
        cp -r artifacts/playwright-report public/playwright
      fi
    - |
      if [ -d "artifacts/allure-report" ]; then
        cp -r artifacts/allure-report public/allure
      fi
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - job: smoke_tests
      optional: true
    - job: regression_tests
      optional: true

notify_slack:
  stage: notify
  when: always
  rules:
    - if: $SLACK_WEBHOOK_URL
  script:
    - |
      if [ "$CI_PIPELINE_STATUS" = "success" ]; then
        EMOJI=":white_check_mark:"
        STATUS="PASSED"
      else
        EMOJI=":x:"
        STATUS="FAILED"
      fi

      REPORT_URL="https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/playwright/"
      ALLURE_URL="https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/allure/"

      MESSAGE="$EMOJI *Playwright Pipeline $STATUS*
Project: $CI_PROJECT_PATH
Branch: $CI_COMMIT_REF_NAME
Pipeline: $CI_PIPELINE_URL
Playwright report: $REPORT_URL
Allure report: $ALLURE_URL"

      curl -X POST -H "Content-type: application/json" \
        --data "{\"text\":\"$MESSAGE\"}" \
        "$SLACK_WEBHOOK_URL"

notify_teams:
  stage: notify
  when: always
  rules:
    - if: $TEAMS_WEBHOOK_URL
  script:
    - |
      if [ "$CI_PIPELINE_STATUS" = "success" ]; then
        STATUS="PASSED"
      else
        STATUS="FAILED"
      fi

      REPORT_URL="https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/playwright/"
      ALLURE_URL="https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/allure/"

      MESSAGE="Playwright Pipeline $STATUS\nProject: $CI_PROJECT_PATH\nBranch: $CI_COMMIT_REF_NAME\nPipeline: $CI_PIPELINE_URL\nPlaywright report: $REPORT_URL\nAllure report: $ALLURE_URL"

      curl -X POST -H "Content-Type: application/json" \
        --data "{\"text\":\"$MESSAGE\"}" \
        "$TEAMS_WEBHOOK_URL"
